<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Tools Collection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-btn.active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: bold; }
        .log-line { font-family: 'Courier New', monospace; border-bottom: 1px solid #1f2937; padding: 4px; }
        .drop-zone { border: 2px dashed #4b5563; transition: all 0.3s; }
        .drop-zone.active { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        
        /* Toast Notification Styles */
        .toast {
            visibility: hidden; min-width: 250px; margin-left: -125px;
            background-color: #1f2937; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed;
            z-index: 1000; left: 50%; bottom: 30px; font-size: 14px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3); border: 1px solid #374151;
        }
        .toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans min-h-screen p-4">

    <header class="max-w-4xl mx-auto flex justify-between items-center mb-8 p-4 bg-gray-800 rounded-2xl shadow-lg">
        <h1 class="text-2xl font-black text-blue-400 italic cursor-pointer" onclick="location.href='/'">WEB TOOLS</h1>
        <div class="flex gap-2 items-center" id="auth-area"></div>
    </header>

    <div class="max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 overflow-hidden relative">
        <div class="flex border-b border-gray-700">
            <button onclick="showTab('dl')" class="tab-btn active flex-1 py-4 text-center hover:bg-gray-750 transition" id="tab-dl">1. ìœ íŠœë¸Œ ë‹¤ìš´ë¡œë“œ <div class="text-[10px] text-orange-400 font-normal mt-1" id="cnt-dl">-</div></button>
            <button onclick="showTab('cv')" class="tab-btn flex-1 py-4 text-center hover:bg-gray-750 transition" id="tab-cv">2. xlsx ->SRT ë³€í™˜ <div class="text-[10px] text-orange-400 font-normal mt-1" id="cnt-cv">-</div></button>
            <button onclick="showTab('mg')" class="tab-btn flex-1 py-4 text-center hover:bg-gray-750 transition" id="tab-mg">3. ìë§‰ í•©ì¹˜ê¸° <div class="text-[10px] text-orange-400 font-normal mt-1" id="cnt-mg">-</div></button>
            <button onclick="showTab('ic')" class="tab-btn flex-1 py-4 text-center hover:bg-gray-750 transition" id="tab-ic">4. í†µí•© ìë§‰ ë³€í™˜ê¸° <div class="text-[10px] text-orange-400 font-normal mt-1" id="cnt-ic">-</div></button>
        </div>

        <div class="p-8 min-h-[500px]">
            <div id="content-dl" class="space-y-6">
                <input type="text" id="yt-url" class="w-full bg-gray-700 border border-gray-600 rounded-xl p-4 focus:ring-2" placeholder="https://youtube.com/...">
                <button onclick="runDownload()" id="btn-dl" class="w-full bg-blue-600 py-4 rounded-xl font-bold">PCë¡œ ë‹¤ìš´ë¡œë“œ</button>
                <div class="hidden bg-gray-700 rounded-full h-2 overflow-hidden" id="prog-box-dl"><div id="prog-bar-dl" class="bg-blue-500 h-full w-0 transition-all duration-300"></div></div>
            </div>

            <div id="content-cv" class="hidden space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <select id="cv-plat" class="w-full bg-gray-700 p-3 rounded-lg"><option value="youtube">ìœ íŠœë¸Œ</option><option value="netflix">ë„·í”Œë¦­ìŠ¤</option></select>
                    <select id="cv-type" class="w-full bg-gray-700 p-3 rounded-lg"><option value="translation" selected>ë²ˆì—­ë§Œ</option><option value="dual">ì´ì¤‘ ìë§‰</option><option value="original">ì›ì–´ë§Œ</option></select>
                </div>
                <div class="drop-zone rounded-2xl p-8 text-center cursor-pointer" id="cv-drop-zone">
                    <p class="text-gray-400 text-sm">xlsx íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.</p>
                    <input type="file" id="cv-file-input" multiple class="hidden" accept=".xlsx">
                </div>
                <div id="cv-file-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                <button onclick="runConvertAll()" id="btn-cv" class="w-full bg-emerald-600 py-4 rounded-xl font-bold">ë³€í™˜ ë° ZIP ë‹¤ìš´ë¡œë“œ</button>
            </div>

            <div id="content-mg" class="hidden space-y-6">
                <input type="file" id="mg-vid" class="block w-full text-sm text-gray-400 file:bg-gray-700">
                <input type="file" id="mg-sub" accept=".srt" class="block w-full text-sm text-gray-400 file:bg-gray-700 mt-4">
                <button onclick="runMerge()" id="btn-mg" class="w-full bg-indigo-600 py-4 rounded-xl font-bold mt-6">í•©ì¹˜ê¸° ì‹œì‘</button>
                <div class="hidden bg-gray-700 rounded-full h-2 overflow-hidden" id="prog-box-mg"><div id="prog-bar-mg" class="bg-indigo-500 h-full w-0 transition-all duration-300"></div></div>
            </div>

            <div id="content-ic" class="hidden space-y-6">
                <div class="drop-zone rounded-2xl p-12 text-center cursor-pointer" id="ic-drop-zone">
                    <p class="text-gray-400 text-sm">ì—¬ê¸°ì— ìë§‰ íŒŒì¼(.smi, .ass, .idx, .sub)ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.</p>
                    <input type="file" id="ic-file-input" multiple class="hidden" accept=".smi,.ass,.idx,.sub">
                </div>

                <div id="ic-file-list" class="space-y-2 max-h-48 overflow-y-auto"></div>

                <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] text-gray-500">ì¶œë ¥ í˜•ì‹</label>
                        <select disabled class="bg-gray-700 p-2 rounded text-sm text-gray-300"><option>ë¬´ì¡°ê±´ SRT ë³€í™˜</option></select>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] text-gray-500">ì–¸ì–´ ì²˜ë¦¬</label>
                        <select id="ic-lang" class="bg-gray-700 p-2 rounded text-sm"><option value="auto">ìë™ ê°ì§€</option><option value="ko">í•œêµ­ì–´ ê°•ì œ</option></select>
                    </div>
                </div>
                <button onclick="runIntegratedConvert()" id="btn-ic" class="w-full bg-orange-600 py-4 rounded-xl font-bold text-lg hover:bg-orange-700 transition">ì„ íƒí•œ íŒŒì¼ ëª¨ë‘ SRTë¡œ ë³€í™˜</button>
            </div>
        </div>
        
        <div class="bg-black p-4 h-48 overflow-y-auto text-xs border-t border-gray-700" id="log-area"></div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast" class="toast"></div>

    <script>
        let lastTitle = null; let icFiles = []; let cvFiles = [];
        const dz = document.getElementById('ic-drop-zone');
        const fi = document.getElementById('ic-file-input');
        const dzCv = document.getElementById('cv-drop-zone');
        const fiCv = document.getElementById('cv-file-input');

        dz.onclick = () => fi.click();
        fi.onchange = (e) => addIcFiles(e.target.files);
        dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('active'); };
        dz.ondragleave = () => dz.classList.remove('active');
        dz.ondrop = (e) => { e.preventDefault(); dz.classList.remove('active'); addIcFiles(e.dataTransfer.files); };

        dzCv.onclick = () => fiCv.click();
        fiCv.onchange = (e) => addCvFiles(e.target.files);
        dzCv.ondragover = (e) => { e.preventDefault(); dzCv.classList.add('active'); };
        dzCv.ondragleave = () => dzCv.classList.remove('active');
        dzCv.ondrop = (e) => { e.preventDefault(); dzCv.classList.remove('active'); addCvFiles(e.dataTransfer.files); };

        function addIcFiles(files) {
            Array.from(files).forEach(f => { if(!icFiles.find(x => x.name === f.name)) icFiles.push(f); });
            renderIcFiles();
        }

        function addCvFiles(files) {
            Array.from(files).forEach(f => { if(!cvFiles.find(x => x.name === f.name)) cvFiles.push(f); });
            renderCvFiles();
        }

        function renderIcFiles() {
            const list = document.getElementById('ic-file-list');
            list.innerHTML = icFiles.map((f, i) => `
                <div class="flex justify-between items-center bg-gray-750 p-4 mb-2 rounded-lg border border-gray-700 text-sm">
                    <span class="truncate">${f.name}</span>
                    <button onclick="removeIcFile(${i})" class="text-red-400 font-bold px-3 py-1 hover:bg-gray-600 rounded">âœ•</button>
                </div>`).join('');
        }

        function renderCvFiles() {
            const list = document.getElementById('cv-file-list');
            list.innerHTML = cvFiles.map((f, i) => `
                <div class="flex justify-between items-center bg-gray-750 p-4 mb-2 rounded-lg border border-gray-700 text-sm">
                    <span class="truncate">${f.name}</span>
                    <button onclick="removeCvFile(${i})" class="text-red-400 font-bold px-3 py-1 hover:bg-gray-600 rounded">âœ•</button>
                </div>`).join('');
        }

        function removeIcFile(i) { icFiles.splice(i, 1); renderIcFiles(); }
        function removeCvFile(i) { cvFiles.splice(i, 1); renderCvFiles(); }
        
        // Custom Toast Function
        function showToast(msg) {
            const x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "toast show";
            setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }

        async function runConvertAll() {
            if(cvFiles.length === 0) return showToast("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
            const fd = new FormData(); 
            cvFiles.forEach(f => fd.append('files[]', f));
            fd.append('sub_type', document.getElementById('cv-type').value);
            fd.append('plat', document.getElementById('cv-plat').value);
            
            log(`SRT ë³€í™˜ ìš”ì²­ (${cvFiles.length}ê°œ)...`, "info");
            try {
                const res = await fetch('/convert_srt_multi', {method:'POST', body:fd});
                if(res.ok) {
                    const blob = await res.blob();
                    downloadBlob(blob, "converted_srt.zip");
                    log("ëª¨ë“  íŒŒì¼ SRT ë³€í™˜ ë° ì••ì¶• ì™„ë£Œ", "success");
                    cvFiles = []; renderCvFiles(); refreshStatus();
                } else {
                    const d = await res.json();
                    log("ì˜¤ë¥˜: " + (d.error || "ë³€í™˜ ì‹¤íŒ¨"), "error");
                }
            } catch(e) { log("í†µì‹  ì˜¤ë¥˜", "error"); }
        }

        async function runIntegratedConvert() {
            if(icFiles.length === 0) return showToast("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
            const fd = new FormData(); icFiles.forEach(f => fd.append('files[]', f));
            log(`í†µí•© ë³€í™˜ ìš”ì²­ (${icFiles.length}ê°œ)...`, "info");
            try {
                const res = await fetch('/convert_srt_integrated', {method:'POST', body:fd});
                const d = await res.json();
                if(d.status === 'success') {
                    d.files.forEach(f => {
                        const blob = new Blob([f.content]); const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob); a.download = f.filename; a.click();
                    });
                    log("ëª¨ë“  íŒŒì¼ SRT ë³€í™˜ ì™„ë£Œ", "success"); refreshStatus();
                }
            } catch(e) { log("í†µì‹  ì˜¤ë¥˜", "error"); }
        }

        async function refreshStatus() {
            const res = await fetch('/api/status'); const d = await res.json();
            const txt = (c) => `ë‚¨ì€ íšŸìˆ˜: ${c}/50`;
            document.getElementById('cnt-dl').innerText = d.is_admin ? "ë¬´ì œí•œ" : txt(d.dl);
            document.getElementById('cnt-cv').innerText = d.is_admin ? "ë¬´ì œí•œ" : txt(d.cv);
            document.getElementById('cnt-mg').innerText = d.is_admin ? "ë¬´ì œí•œ" : txt(d.mg);
            document.getElementById('cnt-ic').innerText = d.is_admin ? "ë¬´ì œí•œ" : txt(d.ic || 50);
            lastTitle = d.last_title;
            const auth = document.getElementById('auth-area');
            if(d.is_admin) auth.innerHTML = `<span class="text-emerald-400 font-bold text-sm mr-2">ğŸ‘‘ ê´€ë¦¬ì</span><button onclick="logout()" class="bg-red-600 px-2 py-1 rounded text-xs">ë¡œê·¸ì•„ì›ƒ</button>`;
            else auth.innerHTML = `<input type="password" id="upw" placeholder="ADMIN PW" class="bg-gray-700 p-1 rounded text-xs w-32"><button onclick="login()" class="bg-blue-600 px-2 py-1 rounded text-xs ml-1">ë¡œê·¸ì¸</button>`;
        }

        // ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€ìš© í•¨ìˆ˜ë“¤
        async function runDownload() {
            const url = document.getElementById('yt-url').value; if(!url) return showToast("URLì´ í•„ìš”í•©ë‹ˆë‹¤.");
            toggleBtn('dl', true); const tid = Math.random().toString(36).substr(2,9); const es = createProgress(tid, 'dl');
            const fd = new FormData(); fd.append('url', url); fd.append('task_id', tid);
            try { const res = await fetch('/download_yt', {method:'POST', body:fd}); if(res.ok) { downloadBlob(await res.blob(), "video.mp4"); log("ë‹¤ìš´ë¡œë“œ ì™„ë£Œ", "success"); refreshStatus(); } } finally { es.close(); toggleBtn('dl', false); }
        }
        function checkLastVideo() { const f = document.getElementById('cv-file').files[0]; if(!f) return showToast("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."); if(lastTitle) { document.getElementById('modal-title').innerText = lastTitle; document.getElementById('modal-wrap').classList.remove('hidden'); } else confirmConvert(false); }
        async function confirmConvert(u) {
            document.getElementById('modal-wrap').classList.add('hidden'); const f = document.getElementById('cv-file').files[0];
            const fd = new FormData(); fd.append('file', f); fd.append('sub_type', document.getElementById('cv-type').value); if(u) fd.append('custom_name', lastTitle);
            try { const res = await fetch('/convert_srt', {method:'POST', body:fd}); const d = await res.json(); if(d.status === 'success') { downloadBlob(new Blob([d.content]), d.filename); log("ë³€í™˜ ì™„ë£Œ", "success"); refreshStatus(); } } catch(e) { log("ì˜¤ë¥˜", "error"); }
        }
        async function runMerge() {
            const v = document.getElementById('mg-vid').files[0]; const s = document.getElementById('mg-sub').files[0]; if(!v || !s) return showToast("ì˜ìƒê³¼ ìë§‰ íŒŒì¼ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤.");
            toggleBtn('mg', true); const tid = Math.random().toString(36).substr(2,9); const es = createProgress(tid, 'mg');
            const fd = new FormData(); fd.append('video', v); fd.append('subtitle', s); fd.append('task_id', tid);
            try { const res = await fetch('/merge_video', {method:'POST', body:fd}); if(res.ok) { downloadBlob(await res.blob(), "merged.mkv"); log("í•©ì¹˜ê¸° ì™„ë£Œ", "success"); refreshStatus(); } } finally { es.close(); toggleBtn('mg', false); }
        }
        function createProgress(tid, type) { const bar = document.getElementById(`prog-bar-${type}`); document.getElementById(`prog-box-${type}`).classList.remove('hidden'); const es = new EventSource(`/progress/${tid}`); es.onmessage = e => { const [p, m] = e.data.split('|'); bar.style.width = p + "%"; }; return es; }
        function toggleBtn(t, d) { const btn = document.getElementById(`btn-${t}`); if(btn) btn.disabled = d; }
        function downloadBlob(b, n) { const url = window.URL.createObjectURL(b); const a = document.createElement('a'); a.href=url; a.download=n; a.click(); }
        function log(m, t='info') { const area = document.getElementById('log-area'); area.innerHTML += `<div class="${t==='error'?'text-red-400':'text-gray-300'}">[${new Date().toLocaleTimeString()}] ${m}</div>`; area.scrollTop = area.scrollHeight; }
        function showTab(id) { ['dl','cv','mg','ic'].forEach(t => { document.getElementById('content-'+t).classList.add('hidden'); document.getElementById('tab-'+t).classList.remove('active'); }); document.getElementById('content-'+id).classList.remove('hidden'); document.getElementById('tab-'+id).classList.add('active'); }
        async function login() { const p = document.getElementById('upw').value; const res = await fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({password:p})}); if((await res.json()).status==='success') refreshStatus(); }
        async function logout() { await fetch('/api/logout', {method:'POST'}); location.reload(); }
        refreshStatus();
    </script>
</body>
</html>